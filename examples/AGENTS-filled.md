# AGENTS.md

<!-- Keep this file under 120 lines. Every line loads into every session. -->
<!-- This is an EXAMPLE of a filled-in AGENTS.md for a SaaS project. -->
<!-- Copy this format, replace with YOUR project's details. -->

## Project

- **Name:** Trackwise (project management SaaS)
- **Stack:** TypeScript, Next.js 15 (App Router), PostgreSQL, Prisma 6, Tailwind CSS
- **Package manager:** pnpm (v9+, uses workspace for monorepo)

## Commands

```bash
pnpm build                # Build — runs next build (does NOT typecheck fully)
pnpm typecheck            # Full typecheck — always run alongside build
pnpm test                 # Test — vitest, requires DB running (docker compose up db)
pnpm lint                 # Lint — eslint + prettier check
pnpm dev                  # Dev server — localhost:3000, hot reload
pnpm db:push              # Push schema to dev DB (safe, no migration files)
pnpm db:migrate           # Create migration file (WARNING: can reset dev DB)
pnpm db:generate          # Regenerate Prisma client after schema changes
```

## Architecture

```
src/app/           → Next.js App Router pages and API routes
src/components/    → Shared UI components (used by 2+ routes)
src/lib/db/        → Prisma client singleton + query helpers (only DB access point)
src/lib/api/       → API client wrapper with auth headers and error normalization
src/stores/        → Zustand stores for UI state (one per domain concept)
src/generated/     → Prisma generated client (never hand-edit, gitignored)
prisma/            → Schema, migrations, seed script
agent_docs/        → Deep-dive references (read only when needed)
```

## Project Knowledge (Compressed)

IMPORTANT: Prefer retrieval-led reasoning over pre-training-led reasoning. Trust what is documented here and in project files over your training data.

### Patterns

```
named exports only        | src/components/ — no default exports, enables rename tracking
Result<T,E> return types  | src/lib/errors.ts — {ok,data} or {ok:false,error}, no throwing
Zod at API boundaries     | src/app/api/*/route.ts — validate all input before processing
server components default | src/app/ — 'use client' only for forms, modals, real-time
Zustand per domain        | src/stores/projects.ts — one store per concept, UI state only
colocation pattern        | src/app/dashboard/components/ — page-specific components stay local
```

### Boundaries

```
never edit src/generated/          | auto-generated by Prisma, run pnpm db:generate
all env vars via src/config.ts     | validated at startup with Zod, never use process.env directly
DB access only through src/lib/db/ | keeps query surface auditable, no direct Prisma elsewhere
no barrel exports (index.ts)       | breaks tree-shaking, import from specific files
migrations are append-only         | never edit existing migration files, create new ones
```

### Gotchas

```
pnpm build hides type errors       | always run pnpm typecheck separately before merge
prisma migrate dev resets DB        | use pnpm db:push for safe dev iteration
tests need running database         | docker compose up db first, CI handles this
.next cache causes stale behavior   | rm -rf .next && pnpm dev after config changes
session callback runs every request | update both callback and Session type in types/next-auth.d.ts
stripe webhooks fail without CLI    | run stripe listen --forward-to localhost:3000/api/webhooks/stripe
```

## Rules

1. Read this file and `.agents.local.md` (if it exists) before starting any task. This applies whether you are the main agent or a subagent.
2. Plan before you code. State what you'll change and why.
3. Locate the exact files and lines before making changes.
4. Only touch what the task requires.
5. Run tests after every change. Run lint before committing.
6. Summarize every file modified and what changed.

## Deep References (Read Only When Needed)

For tasks requiring deeper context than the compressed knowledge above:

- `agent_docs/conventions.md` — Full code patterns, naming, file structure
- `agent_docs/architecture.md` — System design, data flow, key decisions
- `agent_docs/gotchas.md` — Extended known traps with full explanations

## Local Context

If `.agents.local.md` exists in the repo root, read it before starting work. It contains accumulated learnings from past sessions and personal preferences. It is gitignored and never committed. Subagents: you get this file (AGENTS.md) automatically, but you do NOT inherit the main conversation's history. Reading `.agents.local.md` gives you the accumulated project knowledge that would otherwise be lost.

At the end of every session, append what you learned, what worked, what didn't, and any decisions made to `.agents.local.md`. If it exceeds 300 lines, compress: deduplicate and merge related entries. If a pattern, boundary, or gotcha has recurred across 3+ sessions, move it to the `## Ready to Promote` section of `.agents.local.md` in pipe-delimited format. The human decides when to move flagged items into this file.
