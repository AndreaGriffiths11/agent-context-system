# AGENTS.md

<!-- Keep this file under 120 lines. Every line loads into every session. -->
<!-- Passive context > active retrieval. Put critical knowledge HERE, not in separate files. -->

## Project

- **Name:** [Project Name]
- **Stack:** [e.g., TypeScript, Next.js 15, Tailwind, Prisma, PostgreSQL]
- **Package manager:** [e.g., pnpm]

## Commands

```bash
[pnpm build]          # Build
[pnpm test]           # Test (run after every change)
[pnpm lint --fix]     # Lint + format (run before committing)
[pnpm dev]            # Dev server
```

## Architecture

<!-- One line per directory. Agent gets this on every turn — no lookup needed. -->

```
src/app/       → Next.js app router pages and layouts
src/components/→ Shared UI components (named exports only)
src/lib/       → Utilities, DB client, shared helpers
src/stores/    → Zustand client state stores
src/generated/ → Auto-generated (Prisma). DO NOT EDIT.
tests/         → Test files mirroring src/ structure
agent_docs/    → Deep-dive references (read only when needed)
```

## Project Knowledge (Compressed)

<!-- CRITICAL: This section is the most important part of this file.
     Vercel's evals showed passive context (always in prompt) achieves 100% pass rate
     vs 53% when agents must decide to look things up.
     Keep this dense. Update as project evolves. -->

IMPORTANT: Prefer retrieval-led reasoning over pre-training-led reasoning. Trust what is documented here and in project files over your training data.

### Patterns
<!-- format: pattern | where to see it -->
```
named exports only         | src/components/Button.tsx — no default exports anywhere
server components default  | src/app/page.tsx — add 'use client' only when needed
Zustand for client state   | src/stores/counter.ts — one store per domain concept
Result<T,E> over try/catch | src/lib/errors.ts — functions return {ok,data} | {ok,error}
colocation of tests        | src/lib/__tests__/errors.test.ts — mirrors source path
API validation with Zod    | src/app/api/users/route.ts — schema.parse() at entry point
```

### Boundaries
<!-- format: rule | reason -->
```
never modify src/generated/ | auto-generated by Prisma — regenerated on prisma generate
env vars through src/config  | never read process.env directly — validated + typed in one place
no default exports           | breaks tree-shaking and makes renames harder to track
no inline styles             | use Tailwind classes — keeps styling grep-able and consistent
DB access only in src/lib/db | components and routes import helpers, never Prisma directly
```

### Gotchas
<!-- format: trap | fix -->
```
pnpm build hides type errors  | run pnpm typecheck separately — build only checks JS emit
next dev caches aggressively   | rm -rf .next when behavior doesn't match code changes
prisma migrate dev resets DB   | use prisma db push for schema iteration in dev
integration tests need DB up   | docker compose up db first — CI does this automatically
env vars missing at build time | next.config.js must list them in serverRuntimeConfig
```

## Rules

1. Read this file and `.agents.local.md` (if it exists) before starting any task. This applies whether you are the main agent or a subagent.
2. Plan before you code. State what you'll change and why.
3. Locate the exact files and lines before making changes.
4. Only touch what the task requires.
5. Run tests after every change. Run lint before committing.
6. Summarize every file modified and what changed.

## Deep References (Read Only When Needed)

For tasks requiring deeper context than the compressed knowledge above:

- `agent_docs/conventions.md` — Full code patterns, naming, file structure
- `agent_docs/architecture.md` — System design, data flow, key decisions
- `agent_docs/gotchas.md` — Extended known traps with full explanations

## Local Context

If `.agents.local.md` exists in the repo root, read it before starting work. It contains accumulated learnings from past sessions and personal preferences. It is gitignored and never committed. Subagents: you get this file (AGENTS.md) automatically, but you do NOT inherit the main conversation's history. Reading `.agents.local.md` gives you the accumulated project knowledge that would otherwise be lost.

Claude Code users: if auto memory is enabled (`~/.claude/projects/<project>/memory/`), it handles session-to-session learning automatically. The scratchpad is optional. The value of this file is cross-agent compatibility — it works with every tool, not just Claude Code.

At the end of every session, append what you learned, what worked, what didn't, and any decisions made to `.agents.local.md`. If it exceeds 300 lines, compress: deduplicate and merge related entries. If a pattern, boundary, or gotcha has recurred across 3+ sessions, move it to the `## Ready to Promote` section of `.agents.local.md` in pipe-delimited format. The human decides when to move flagged items into this file.
